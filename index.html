<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SSO通用登录验证</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
    .container {width:100%;max-width:600px;margin:100px auto;padding:20px;text-align:center;}
    .success {color:#28a745;font-size:18px;margin:20px 0;}
    .error {color:#dc3545;font-size:18px;margin:20px 0;}
    .loading {color:#007bff;font-size:16px;}
    a {color:#007bff;text-decoration:none;}
    a:hover {text-decoration:underline;}
  </style>
  <!-- 极简jQuery CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
</head>
<body>
  <div class="container" id="app"><div class="loading">正在检测登录状态...</div></div>

  <script>
    // 配置&全局变量（极简整合）
    const C = {
      SSO_LOGIN: "https://sso.stu.edu.cn/login",
      SSO_VALIDATE: "https://sso.stu.edu.cn/serviceValidate",
      ALLOW: ["22ycui"]
    },
    SERVICE_URL = `${location.protocol}//${location.host}${location.pathname}`,
    LOGIN_URL = `${C.SSO_LOGIN}?service=${encodeURIComponent(SERVICE_URL)}`;

    // jQuery 入口+主逻辑（全程链式/极简写法）
    $(async () => {
      const $app = $("#app");
      try {
        // 1. 获取ticket
        const ticket = new URLSearchParams(location.search).get("ticket");
        if (!ticket) return $app.html(`<h3>未登录</h3><div class="error">请先登录以继续</div><p><a href="${LOGIN_URL}">跳转登录</a></p>`);
        
        // 2. 验证ticket（极简ajax）
        $app.find(".loading").text("检测到凭证，正在验证...");
        const res = await $.ajax({
          url: C.SSO_VALIDATE,
          data: { service: SERVICE_URL, ticket },
          headers: { Connection: "close" },
          cache: false,
          crossDomain: true
        });

        // 3. 解析XML（精简核心逻辑）
        const xml = new DOMParser().parseFromString(res, "text/xml"),
              successNode = xml.evaluate('//*[local-name()="authenticationSuccess"]', xml, null, 9, null).singleNodeValue,
              failNode = xml.evaluate('//*[local-name()="authenticationFailure"]', xml, null, 9, null).singleNodeValue;
        
        // 4. 验证失败处理
        if (failNode || !successNode) {
          const msg = failNode?.textContent.trim() || "验证失败，格式异常";
          return $app.html(`<h3>验证失败</h3><div class="error">${msg}</div><p><a href="${LOGIN_URL}">重新登录</a></p>`);
        }

        // 5. 权限判断+结果渲染（极简三元）
        const un = successNode.firstElementChild.textContent.trim();
        if (!un) throw new Error("无有效用户名");
        if (C.ALLOW.includes(un)) {
          $app.html(`<h3>验证成功</h3><div class="success">欢迎您，${un}！</div><div class="success">已获得使用权限</div>`);
          alert(`验证成功，欢迎 ${un}！`);
        } else {
          $app.html(`<h3>权限不足</h3><div class="error">${un}，您暂无使用权限</div>`);
        }
        history.replaceState({}, "", SERVICE_URL); // 清除url中的ticket
      } catch (e) {
        // 全局异常（极简提示）
        $app.html(`<h3>操作异常</h3><div class="error">${e.message || "网络/服务器异常"}</div><p><a href="${LOGIN_URL}">重新尝试</a></p>`);
        console.error("SSO异常：", e);
      }
    });
  </script>
</body>
</html>